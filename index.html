<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘å€‘çš„æ‡·å­•æ—¥è¨˜ ğŸ‘¶ v2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-pink-50 min-h-screen pb-20 font-sans text-gray-800">

    <header class="bg-white p-6 rounded-b-3xl shadow-md text-center border-b-2 border-pink-100">
        <h1 class="text-xl font-bold">æˆ‘å€‘çš„æ‡·å­•ç­†è¨˜</h1>
        <p class="text-sm text-pink-500 mt-1 italic">è¨˜éŒ„æ¯ä¸€ç­†å¹¸ç¦æ”¯å‡º</p>
    </header>

    <script>
        const SUPABASE_URL = 'https://uashjbomzjaroxyjiion.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhc2hqYm9temphcm94eWppaW9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTIzODksImV4cCI6MjA4MzAyODM4OX0.PRcS3VpX3dkKS5qRf-SqBNCytVvVEdO1mEGdk6SYR2U';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const emojiList = ['ğŸ¥', 'ğŸ’Š', 'ğŸ¼', 'ğŸ§·', 'ğŸ§¸', 'ğŸ‘•', 'ğŸ§¼', 'ğŸš—', 'ğŸ±', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘¶'];

        async function fetchExpenses() {
            const { data, error } = await _supabase.from('expenses').select('*');
            if (error) {
                console.error('è®€å–å¤±æ•—:', error);
                return;
            }
            renderList(data);
        }

        async function addExpense(category) {
            const amount = prompt(`è¼¸å…¥ã€Œ${category}ã€é‡‘é¡:`);
            if (!amount || isNaN(amount)) return;
            const note = prompt(`å‚™è¨»å…§å®¹:`, category);
            
            let emojiMenu = "è«‹é¸æ“‡åœ–æ¡ˆç·¨è™Ÿï¼š\n";
            emojiList.forEach((e, i) => { emojiMenu += `${i + 1}. ${e}  `; if((i+1)%4==0) emojiMenu += "\n"; });
            emojiMenu += "0. æ‰‹å‹•è¼¸å…¥å…¶ä»–";

            const choice = prompt(emojiMenu, "1");
            let icon = "";
            if (choice === "0") {
                icon = prompt("è«‹è¼¸å…¥ Emoji:", "ğŸ");
            } else {
                icon = emojiList[parseInt(choice) - 1] || 'ğŸ';
            }

            const payer = prompt(`èª°ä»˜çš„éŒ¢ï¼Ÿ (çˆ¸/åª½)`, 'åª½');
            const finalNote = `${icon} ${note}`;

            const { error } = await _supabase
                .from('expenses')
                .insert([{ amount: parseFloat(amount), category, note: finalNote, payer }]);

            if (error) alert('æ–°å¢å¤±æ•—ï¼š' + error.message);
            else fetchExpenses();
        }

        // --- åŠ å¼·ç‰ˆåˆªé™¤åŠŸèƒ½ ---
        async function deleteExpense(id) {
            if (!id) {
                alert('æ‰¾ä¸åˆ°é€™ç­†è³‡æ–™çš„ IDï¼Œè«‹é‡æ–°æ•´ç†ç¶²é å†è©¦');
                return;
            }
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;

            const { error } = await _supabase
                .from('expenses')
                .delete()
                .eq('id', id); // é€™è£¡æœƒæ ¹æ“š ID åˆªé™¤

            if (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message + '\nè«‹æª¢æŸ¥ Supabase DELETE æ¬Šé™æ˜¯å¦é–‹å•Ÿ');
                console.error('åˆªé™¤å‡ºéŒ¯:', error);
            } else {
                fetchExpenses();
            }
        }

        function renderList(list) {
            const listEl = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-amount');
            let total = 0;
            listEl.innerHTML = '';

            if (!list || list.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-400 py-4">ç›®å‰é‚„æ²’æœ‰ç´€éŒ„å–”</p>';
                totalEl.innerText = '$ 0';
                return;
            }

            list.sort((a, b) => b.id - a.id).forEach(item => {
                total += item.amount;
                const noteParts = item.note.split(' ');
                const displayIcon = noteParts.length > 1 ? noteParts[0] : 'ğŸ';
                const displayText = noteParts.length > 1 ? noteParts.slice(1).join(' ') : item.note;

                const html = `
                    <div class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div class="flex items-center">
                            <div class="bg-pink-100 p-2 rounded-lg mr-3 text-2xl shadow-inner">${displayIcon}</div>
                            <div>
                                <p class="font-bold text-gray-700">${displayText}</p>
                                <p class="text-xs text-pink-400 font-medium">æ”¯ä»˜è€…: ${item.payer || 'æœªè¨»è¨˜'}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-rose-500">-$${item.amount}</span>
                            <button onclick="deleteExpense(${item.id})" class="p-2 text-gray-300 hover:text-red-500 transition-colors">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>`;
                listEl.insertAdjacentHTML('beforeend', html);
            });
            totalEl.innerText = `$ ${total.toLocaleString()}`;
        }

        window.onload = fetchExpenses;
    </script>

    <main class="p-4">
        <div class="bg-gradient-to-br from-rose-400 to-pink-500 p-8 rounded-3xl text-white shadow-xl mb-6 text-center">
            <p class="text-sm opacity-80 mb-2 font-medium tracking-widest uppercase">Total Expenses</p>
            <h2 id="total-amount" class="text-5xl font-extrabold">$ 0</h2>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-8 text-center">
            <button onclick="addExpense('ç”¢æª¢')" class="bg-white p-3 rounded-2xl shadow-sm active:scale-95 transition border-b-4 border-blue-200">
                <i class="fas fa-stethoscope text-blue-400 text-xl mb-1"></i>
                <p class="text-xs font-bold text-gray-600">ç”¢æª¢</p>
            </button>
            <button onclick="addExpense('ç”¨å“')" class="bg-white p-3 rounded-2xl shadow-sm active:scale-95 transition border-b-4 border-orange-200">
                <i class="fas fa-baby-carriage text-orange-400 text-xl mb-1"></i>
                <p class="text-xs font-bold text-gray-600">ç”¨å“</p>
            </button>
            <button onclick="addExpense('ç‡Ÿé¤Š')" class="bg-white p-3 rounded-2xl shadow-sm active:scale-95 transition border-b-4 border-green-200">
                <i class="fas fa-pills text-green-400 text-xl mb-1"></i>
                <p class="text-xs font-bold text-gray-600">ç‡Ÿé¤Šå“</p>
            </button>
        </div>

        <section>
            <h3 class="font-bold text-gray-700 mb-4 px-2 italic underline decoration-pink-300 decoration-2">æœ€è¿‘æ”¯å‡ºç´€éŒ„</h3>
            <div id="expense-list" class="space-y-3">
                <p class="text-center text-gray-400">è¼‰å…¥ä¸­...</p>
            </div>
        </section>
    </main>

</body>
</html>

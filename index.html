<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘å€‘çš„æ‡·å­•æ—¥è¨˜ v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-pink-50 min-h-screen pb-24 font-sans text-gray-800">

    <header class="bg-white p-6 rounded-b-3xl shadow-md flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold">æˆ‘å€‘çš„æ‡·å­•ç­†è¨˜</h1>
            <p id="month-label" class="text-xs text-pink-500 font-medium">æº–å‚™ä¸­...</p>
        </div>
        <select id="month-filter" onchange="fetchExpenses()" class="bg-pink-100 text-pink-600 text-sm font-bold py-2 px-3 rounded-xl border-none outline-none">
            <option value="all">å…¨éƒ¨</option>
            <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
            <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
        </select>
    </header>

    <main class="p-4">
        <div class="bg-gradient-to-br from-rose-400 to-pink-500 p-8 rounded-3xl text-white shadow-xl mb-6 text-center">
            <h2 id="total-amount" class="text-5xl font-extrabold">$ 0</h2>
        </div>

        <section id="input-panel" class="hidden bg-white p-6 rounded-3xl shadow-lg mb-6 border-2 border-pink-200">
            <h3 id="panel-title" class="font-bold text-gray-700 mb-4 text-center">æ–°å¢ç´€éŒ„</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">é‡‘é¡</label>
                    <input type="number" id="form-amount" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-pink-300">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">å‚™è¨»</label>
                    <input type="text" id="form-note" placeholder="ä¾‹å¦‚ï¼šè²·å°¿å¸ƒ" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 focus:ring-pink-300">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">é¸æ“‡åœ–æ¡ˆ</label>
                    <div id="emoji-picker" class="flex flex-wrap gap-2 text-2xl bg-gray-50 p-3 rounded-xl">
                        </div>
                    <input type="hidden" id="form-icon" value="ğŸ">
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 mb-1">æ”¯ä»˜è€…</label>
                        <select id="form-payer" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                            <option value="åª½">åª½</option>
                            <option value="çˆ¸">çˆ¸</option>
                        </select>
                    </div>
                    <div class="flex-1 flex items-end">
                        <button onclick="saveExpense()" class="w-full bg-rose-500 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition">å„²å­˜</button>
                    </div>
                </div>
                <button onclick="togglePanel()" class="w-full text-gray-400 text-xs py-2">å–æ¶ˆ</button>
            </div>
        </section>

        <div class="grid grid-cols-3 gap-3 mb-8 text-center">
            <button onclick="openPanel('ç”¢æª¢')" class="bg-white p-3 rounded-2xl shadow-sm border-b-4 border-blue-200">
                <i class="fas fa-stethoscope text-blue-400 text-xl mb-1"></i><p class="text-xs font-bold text-gray-600">ç”¢æª¢</p>
            </button>
            <button onclick="openPanel('ç”¨å“')" class="bg-white p-3 rounded-2xl shadow-sm border-b-4 border-orange-200">
                <i class="fas fa-baby-carriage text-orange-400 text-xl mb-1"></i><p class="text-xs font-bold text-gray-600">ç”¨å“</p>
            </button>
            <button onclick="openPanel('ç‡Ÿé¤Š')" class="bg-white p-3 rounded-2xl shadow-sm border-b-4 border-green-200">
                <i class="fas fa-pills text-green-400 text-xl mb-1"></i><p class="text-xs font-bold text-gray-600">ç‡Ÿé¤Š</p>
            </button>
        </div>

        <section id="expense-list" class="space-y-3"></section>
    </main>

    <script>
        const SUPABASE_URL = 'https://uashjbomzjaroxyjiion.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhc2hqYm9temphcm94eWppaW9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0NTIzODksImV4cCI6MjA4MzAyODM4OX0.PRcS3VpX3dkKS5qRf-SqBNCytVvVEdO1mEGdk6SYR2U';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const emojiList = ['ğŸ¥', 'ğŸ’Š', 'ğŸ¼', 'ğŸ§·', 'ğŸ§¸', 'ğŸ‘•', 'ğŸ§¼', 'ğŸš—', 'ğŸ±', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘¶'];
        let currentCategory = '';

        // ç”Ÿæˆ Emoji é¸å–®
        const emojiPicker = document.getElementById('emoji-picker');
        emojiList.forEach(e => {
            const btn = document.createElement('button');
            btn.innerText = e;
            btn.className = "emoji-option p-1 rounded-lg border-2 border-transparent";
            btn.onclick = () => selectEmoji(e, btn);
            emojiPicker.appendChild(btn);
        });

        function selectEmoji(e, btn) {
            document.querySelectorAll('.emoji-option').forEach(b => b.classList.remove('border-pink-400', 'bg-white'));
            btn.classList.add('border-pink-400', 'bg-white');
            document.getElementById('form-icon').value = e;
        }

        function togglePanel() {
            const panel = document.getElementById('input-panel');
            panel.classList.toggle('hidden');
        }

        function openPanel(category) {
            currentCategory = category;
            document.getElementById('panel-title').innerText = `æ–°å¢ã€Œ${category}ã€ç´€éŒ„`;
            document.getElementById('form-note').value = category;
            document.getElementById('form-amount').value = '';
            document.getElementById('input-panel').classList.remove('hidden');
            window.scrollTo({ top: 100, behavior: 'smooth' });
        }

        async function saveExpense() {
            const amount = document.getElementById('form-amount').value;
            const note = document.getElementById('form-note').value;
            const icon = document.getElementById('form-icon').value;
            const payer = document.getElementById('form-payer').value;

            if (!amount) return alert('è«‹è¼¸å…¥é‡‘é¡');

            const finalNote = `${icon} ${note}`;
            const { error } = await _supabase.from('expenses').insert([{ 
                amount: parseFloat(amount), 
                category: currentCategory, 
                note: finalNote, 
                payer 
            }]);

            if (error) alert('å„²å­˜å¤±æ•—');
            else {
                togglePanel();
                fetchExpenses();
            }
        }

        async function fetchExpenses() {
            const month = document.getElementById('month-filter').value;
            let { data, error } = await _supabase.from('expenses').select('*').order('created_at', { ascending: false });
            if (error) return;

            if (month !== "all") {
                data = data.filter(item => (new Date(item.created_at).getMonth() + 1) === parseInt(month));
                document.getElementById('month-label').innerText = `${month}æœˆ æ”¯å‡ºç´€éŒ„`;
            } else {
                document.getElementById('month-label').innerText = `æ‰€æœ‰ç´€éŒ„`;
            }
            renderList(data);
        }

        async function deleteExpense(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
            await _supabase.from('expenses').delete().eq('id', id);
            fetchExpenses();
        }

        function renderList(list) {
            const listEl = document.getElementById('expense-list');
            const totalEl = document.getElementById('total-amount');
            let total = 0;
            listEl.innerHTML = '';

            list.forEach(item => {
                total += item.amount;
                const noteParts = item.note.split(' ');
                const icon = noteParts[0];
                const text = noteParts.slice(1).join(' ');
                const date = new Date(item.created_at);

                listEl.insertAdjacentHTML('beforeend', `
                    <div class="bg-white p-4 rounded-xl flex justify-between items-center shadow-sm">
                        <div class="flex items-center">
                            <div class="bg-pink-100 p-2 rounded-lg mr-3 text-2xl">${icon}</div>
                            <div>
                                <p class="font-bold text-gray-700">${text}</p>
                                <p class="text-[10px] text-gray-400">${date.getMonth()+1}/${date.getDate()} Â· ${item.payer}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-rose-500">-$${item.amount.toLocaleString()}</span>
                            <button onclick="deleteExpense(${item.id})" class="text-gray-200 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`);
            });
            totalEl.innerText = `$ ${total.toLocaleString()}`;
        }

        window.onload = fetchExpenses;
    </script>
</body>
</html>
